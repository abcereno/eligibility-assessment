<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Assessment Form with Local Storage</title>
    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHqT3UJZ6VvGP9I8zK7s2w6iQ6oz/E1z+PSOrk2Cn6VxbQec/0k7zBKQgGy+HawJ4F5NfL/Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Google Fonts (Colours and Fonts MUST NOT change) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Elliot+Sans:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- HTML2PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Add jsPDF and html2canvas libraries separately -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      /*========================================================================
        DESIGN TOKENS & BASE STYLES (Colours and Fonts MUST NOT change)
      =========================================================================*/
      :root {
        /* Colours (unchanged) */
        --primary-color: #fdb715;
        --secondary-color: #373b40;
        --background-color: #f0f2f5;
        --light-color: #ffffff;
        --accent-color: #e0a60d;

        /* Fonts (unchanged) */
        --font-base: "Open Sans", Arial, sans-serif;
        --font-heading: "Elliot Sans", sans-serif;

        /* Spacing & Sizing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 10px;

        /* Transition */
        --transition-default: 0.3s ease;
      }

      /* Global Reset */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-base);
        color: var(--secondary-color);
        background: var(--background-color);
        line-height: 1.5;
        padding-top: 4.375rem; /* ~70px for fixed navbar */
        overflow-x: hidden;
        /* Body appears with a smooth fade in */
        opacity: 0;
        animation: bodyFadeIn 1s forwards;
      }
      @keyframes bodyFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Reduced Motion for Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.001ms !important;
          transition-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
        }
      }

      /*========================================================================
                           COMPONENT: NAVBAR
      =========================================================================*/
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: var(--primary-color);
        color: var(--secondary-color);
        padding: 0.9375rem 1.875rem; /* 15px 30px */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .navbar__logo {
        display: flex;
        align-items: center;
      }
      .navbar__logo img {
        max-height: 3.75rem; /* 60px */
        width: auto;
      }
      @media (max-width: 768px) {
        .navbar__logo img {
          max-height: 2.5rem; /* 40px */
        }
      }
      @media (max-width: 480px) {
        .navbar__logo img {
          max-height: 1.875rem; /* 30px */
        }
      }

      /*========================================================================
                           LAYOUT & TYPOGRAPHY
      =========================================================================*/
      .container {
        max-width: 75rem; /* 1200px */
        margin: 0 auto;
        padding: var(--spacing-md);
      }
      h1,
      h2 {
        font-family: var(--font-heading);
        color: var(--secondary-color);
        margin-bottom: 0.5em;
      }

      /*========================================================================
                        UTILITY: ANIMATE ON SCROLL
      =========================================================================*/
      .animate-on-scroll {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity var(--transition-default),
          transform var(--transition-default);
      }
      .animate-on-scroll.in-view {
        opacity: 1;
        transform: translateY(0);
      }

      /*========================================================================
                           COMPONENT: CARD
      =========================================================================*/
      .card {
        background: var(--light-color);
        border-radius: var(--radius-lg);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .card:hover {
        transform: translateY(-5px) scale(1.01);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }

      /*========================================================================
                           FORM ELEMENTS & LABELS
      =========================================================================*/
      .form-section {
        margin-bottom: var(--spacing-md);
      }
      label {
        display: block;
        margin-top: var(--spacing-sm);
        font-weight: bold;
        color: var(--secondary-color);
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 0.75rem;
        margin-top: var(--spacing-xs);
        border: 1px solid #b6bbbf;
        border-radius: var(--radius-sm);
        transition: border var(--transition-default),
          box-shadow var(--transition-default);
        font-size: 1rem;
      }
      input:focus,
      textarea:focus,
      select:focus {
        border: 2px solid var(--primary-color);
        box-shadow: 0 0 15px rgba(253, 183, 21, 0.3);
        outline: none;
      }
      input:hover,
      textarea:hover,
      select:hover {
        box-shadow: 0 0 10px var(--primary-color);
      }

      /*========================================================================
                          SPECIAL: QUALIFICATION DROPDOWN ANIMATION
      =========================================================================*/
      #qualificationSelect {
        animation: dropdownPulse 2s infinite;
      }
      @keyframes dropdownPulse {
        0% {
          border-color: var(--primary-color);
        }
        50% {
          border-color: transparent;
        }
        100% {
          border-color: var(--primary-color);
        }
      }

      /*========================================================================
                           COMPONENT: RESULTS & PROGRESS
      =========================================================================*/
      #resultsContainer {
        background: linear-gradient(145deg, var(--light-color), #f9f9f9);
        border-radius: var(--radius-lg);
        padding: 1.5625rem; /* 25px */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin: 1.25rem 0;
        border: 2px solid var(--primary-color);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: none;
      }
      #resultsContainer h3 {
        color: var(--secondary-color);
        font-size: 1.5em;
        margin-bottom: 1.25rem;
        text-align: center;
        position: relative;
      }
      #resultsContainer h3::after {
        content: "";
        display: block;
        width: 3.125rem; /* 50px */
        height: 0.1875rem; /* 3px */
        background: var(--primary-color);
        margin: 0.625rem auto; /* 10px */
        border-radius: 2px;
      }
      .progress-container {
        margin: 0.9375rem 0; /* 15px */
        padding: 0.625rem; /* 10px */
      }
      .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
        font-weight: bold;
        color: var(--secondary-color);
      }
      .progress-bar {
        height: 1.5625rem; /* 25px */
        background: #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--primary-color), #ffcd4b);
        border-radius: 12px;
        transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: progressShine 2s infinite;
      }
      @keyframes progressShine {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(12.5rem, 1fr));
        gap: 1.25rem;
        margin-top: 1.25rem;
      }
      .stat-box {
        background: var(--light-color);
        padding: 0.9375rem;
        border-radius: var(--radius-md);
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: transform var(--transition-default);
      }
      .stat-box:hover {
        transform: translateY(-5px);
      }
      .stat-label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 0.3125rem;
      }
      .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--secondary-color);
      }

      /*========================================================================
                           COMPONENT: TABLES & LISTS
      =========================================================================*/
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
        table-layout: fixed;
      }
      thead {
        background-color: #feebc7;
      }
      #localStorageTable thead th {
        white-space: nowrap;
      }
      th,
      td {
        border: 1px solid #b6bbbf;
        padding: 0.75em;
        vertical-align: middle;
        color: var(--secondary-color);
        word-wrap: break-word;
      }
      tr:nth-child(even) {
        background: #f9f9f9;
      }
      tr:hover {
        background: #f1f1f1;
      }
      table th:nth-child(2),
      table th:nth-child(3),
      table th:nth-child(4),
      table td:nth-child(2),
      table td:nth-child(3),
      table td:nth-child(4) {
        text-align: center;
      }

      /* Styled Checkboxes */
      input[type="checkbox"] {
        appearance: none;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-sm);
        background-color: var(--light-color);
        cursor: pointer;
        transition: all var(--transition-default);
        position: relative;
      }

      input[type="checkbox"]:hover {
        box-shadow: 0 0 10px var(--primary-color);
      }

      input[type="checkbox"]:checked {
        background-color: var(--primary-color);
        animation: checkboxPulse 1.5s infinite ease-in-out;
      }

      input[type="checkbox"]:checked::after {
        content: "✓";
        color: var(--secondary-color);
        font-weight: bold;
        font-size: 1.125rem;
        position: absolute;
        top: 0;
        left: 0.3125rem;
        line-height: 1.375rem;
        animation: tickAnimation 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
      }

      @keyframes tickAnimation {
        0% {
          transform: scale(0) rotate(-45deg);
          opacity: 0;
        }
        50% {
          transform: scale(1.4) rotate(0deg);
          opacity: 0.7;
        }
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      @keyframes checkboxPulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 5px var(--primary-color);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 0 15px var(--primary-color);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 5px var(--primary-color);
        }
      }

      /* Date Input Styling */
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
      }

      input[type="date"] {
        position: relative;
        padding-left: 35px !important;
      }

      input[type="date"]::-webkit-datetime-edit {
        position: relative;
        left: 15px;
      }

      /*========================================================================
                           COMPONENT: BUTTONS
      =========================================================================*/
      .button-row {
        margin-top: var(--spacing-md);
        margin-bottom: 2rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .button-row .pdf-button {
        width: 100%;
        max-width: 400px;
        padding: 15px 30px;
        background: linear-gradient(135deg, #fdb715, #ffcd4b);
        border: none;
        border-radius: 8px;
        color: var(--secondary-color);
        font-family: var(--font-base);
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(253, 183, 21, 0.3);
        position: relative;
        overflow: hidden;
      }

      .button-row .pdf-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(
          120deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: lightSweep 3s infinite linear;
      }

      @keyframes lightSweep {
        0% {
          left: -100%;
        }
        100% {
          left: 200%;
        }
      }

      .button-row .pdf-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(253, 183, 21, 0.4),
          0 0 20px rgba(253, 183, 21, 0.2);
        background: linear-gradient(135deg, #ffcd4b, #fdb715);
      }

      .button-row .pdf-button:active {
        transform: translateY(-1px);
      }

      .button-row .pdf-button i {
        margin-right: 10px;
        font-size: 1.2em;
      }

      .button-row .secondary-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .button-row .secondary-buttons button {
        padding: 10px 20px;
        margin: 0;
        cursor: pointer;
        background-color: var(--primary-color);
        border: none;
        border-radius: 6px;
        color: var(--secondary-color);
        font-family: var(--font-base);
        font-weight: bold;
        font-size: 0.9rem;
        transition: transform var(--transition-default),
          box-shadow var(--transition-default);
        position: relative;
        overflow: hidden;
      }

      .button-row .secondary-buttons button:hover {
        background-color: #e0a60d;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .button-row .secondary-buttons button:active {
        transform: translateY(1px);
      }

      /*========================================================================
                     ACTION BUTTONS ICON SCALING (using <img> tags)
      =========================================================================*/
      .action-buttons button img {
        width: 24px;
        height: 24px;
        vertical-align: middle;
      }
      @media (max-width: 600px) {
        .action-buttons button img {
          width: 20px;
          height: 20px;
        }
      }

      /*========================================================================
                          COMPONENT: WORK HISTORY
      =========================================================================*/
      .work-history {
        background: var(--light-color);
        border: 1px solid #b6bbbf;
        border-radius: var(--radius-md);
        padding: 0.9375rem;
        margin: 1.25rem 0;
      }
      .work-history summary {
        font-size: 1.2em;
        font-weight: bold;
        background: var(--primary-color);
        color: var(--secondary-color);
        padding: 0.625rem;
        border-radius: 6px;
        cursor: pointer;
      }
      .work-history h3 {
        font-size: 1.1em;
        margin-top: 0.9375rem;
        margin-bottom: 0.625rem;
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.3125rem;
      }
      .work-history ol {
        margin-left: 1.25rem;
        margin-top: 0.625rem;
      }
      .work-history li {
        margin-bottom: 0.625rem;
      }
      .work-history ul {
        margin-left: 1.25rem;
        list-style: disc;
      }
      .work-history hr {
        border: none;
        border-top: 1px dashed #ccc;
        margin: 0.9375rem 0;
      }

      /*========================================================================
                          COMPONENT: MODAL
      =========================================================================*/
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .modal.show {
        opacity: 1;
        transform: scale(1);
      }
      .modal-content {
        background: var(--light-color);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 25rem; /* 400px */
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .modal-actions {
        margin-top: var(--spacing-md);
        display: flex;
        justify-content: space-around;
      }
      .modal-button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
      }
      .modal-button.confirm {
        background-color: var(--primary-color);
        color: var(--secondary-color);
      }
      .modal-button.cancel {
        background-color: #ccc;
        color: var(--secondary-color);
      }

      /*========================================================================
                          COMPONENT: TOAST
      =========================================================================*/
      #toastContainer {
        position: fixed;
        bottom: 1.25rem;
        right: 1.25rem;
        z-index: 3000;
      }
      .toast {
        min-width: 12.5rem;
        margin-top: 0.625rem;
        padding: 0.9375rem 1.25rem;
        background: var(--primary-color);
        color: var(--secondary-color);
        border-radius: 5px;
        opacity: 0;
        transform: translateY(1.25rem);
        transition: opacity 0.5s ease, transform 0.5s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.error {
        background: #e74c3c;
      }

      /*========================================================================
                          COMPONENT: LOCAL STORAGE TABLE
      =========================================================================*/
      #localStorageTable {
        border: 2px solid var(--primary-color);
        border-collapse: collapse;
        border-radius: var(--radius-md);
        overflow: hidden;
        margin-top: var(--spacing-md);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      #localStorageTable thead {
        background-color: var(--primary-color);
        color: var(--secondary-color);
      }

      /*========================================================================
                   COMPONENT: QUALIFICATION & UNITS TABLE
      =========================================================================*/
      .qualification-table col:nth-child(1) {
        width: calc(100% - 18.75rem); /* 300px */
      }
      .qualification-table col:nth-child(2),
      .qualification-table col:nth-child(3) {
        width: 9.375rem; /* 150px */
      }
      .qualification-table th:nth-child(2),
      .qualification-table th:nth-child(3),
      .qualification-table td:nth-child(2),
      .qualification-table td:nth-child(3) {
        white-space: normal;
        word-break: normal;
        width: 9.375rem;
        max-width: 9.375rem;
      }

      /*========================================================================
                   COMPONENT: UNITS LISTS (Evidence & Referee)
      =========================================================================*/
      .units-lists-container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.25rem;
        margin-top: var(--spacing-md);
      }
      .evidence-units,
      .referee-units {
        background: var(--light-color);
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform var(--transition-default),
          box-shadow var(--transition-default);
      }
      .evidence-units:hover,
      .referee-units:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .evidence-units h4,
      .referee-units h4 {
        margin-bottom: var(--spacing-sm);
        font-family: var(--font-heading);
        font-size: 1.2em;
        color: var(--secondary-color);
        border-bottom: 1px solid var(--primary-color);
        padding-bottom: 0.3125rem;
      }
      .evidence-units pre,
      .referee-units pre {
        font-family: var(--font-base);
        font-size: 1rem;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-wrap: break-word;
        max-width: 100%;
        margin: 0;
        padding: 0.3125rem;
        background-color: #f9f9f9;
        border-radius: var(--radius-sm);
        border: 1px dashed #ccc;
      }

      /*========================================================================
                               MOBILE RESPONSIVE ADJUSTMENTS
      =========================================================================*/
      @media (max-width: 768px) {
        body {
          padding-top: 5rem; /* 80px */
          font-size: 0.95em;
        }
        .units-lists-container,
        .stats-grid {
          grid-template-columns: 1fr;
        }
        table,
        th,
        td {
          font-size: 0.9em;
        }
        .button-row button,
        .action-buttons button {
          padding: 0.75rem 1.5rem;
          font-size: 0.9em;
        }
      }
      @media (max-width: 600px) {
        .qualification-table col:nth-child(1) {
          width: calc(100% - 10rem) !important;
        }
        .qualification-table col:nth-child(2),
        .qualification-table col:nth-child(3) {
          width: 5rem !important;
        }
        .qualification-table th,
        .qualification-table td {
          font-size: 0.8em;
          padding: 0.5rem;
        }
        h1 {
          font-size: 1.5em;
        }
        h2 {
          font-size: 1.2em;
        }
        h3 {
          font-size: 1em;
        }
      }

      /*========================================================================
                           COMPONENT: TGA LINK BUTTON
      =========================================================================*/
      .tga-link-button {
        display: inline-block;
        background: var(--background-color);
        color: var(--secondary-color);
        border: 2px solid var(--primary-color);
        border-radius: 50px;
        padding: 4px 12px;
        margin-top: 8px;
        font-size: 0.85em;
        text-decoration: none;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .tga-link-button:hover {
        background: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(253, 183, 21, 0.2);
      }

      .tga-link-button:active {
        transform: translateY(0);
      }

      .tga-link-button i {
        margin-right: 6px;
        transition: transform 0.3s ease;
      }

      .tga-link-button:hover i {
        transform: translateX(3px);
      }

      @keyframes buttonPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(253, 183, 21, 0.4);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(253, 183, 21, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(253, 183, 21, 0);
        }
      }

      .tga-link-button:focus {
        outline: none;
        animation: buttonPulse 1.5s infinite;
      }

      /* PDF Preview Modal Styles */
      .pdf-preview-content {
        width: 95%;
        max-width: 800px;
        max-height: 90vh;
        padding: 20px;
        background: white;
      }

      .pdf-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: var(--secondary-color);
      }

      #pdfPreviewContainer {
        max-height: calc(90vh - 140px);
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .pdf-preview-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      /* PDF Template Styles */
      .pdf-content {
        padding: 25px;
        background: white;
        width: 794px; /* A4 width at 96 DPI */
        min-height: 1123px; /* A4 height at 96 DPI */
        margin: 0 auto;
        position: relative;
        box-sizing: border-box;
        font-family: "Open Sans", Arial, sans-serif !important;
      }

      .pdf-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border-bottom: 2px solid #fdb715;
        position: relative;
      }

      .pdf-logo {
        max-height: 50px;
        width: auto;
        margin: 0 auto;
        display: block;
      }

      .assessment-status {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-badge {
        background: #f8f9fa;
        color: #2d3436;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .status-badge::before {
        content: "✓";
        display: inline-block;
        color: #27ae60;
        font-weight: bold;
        font-size: 12px;
      }

      .pdf-header h1 {
        font-size: 24px;
        margin: 20px 0 10px;
        color: #373b40;
        font-family: "Elliot Sans", Arial, sans-serif !important;
        font-weight: bold;
        clear: both;
      }

      .student-info {
        margin-bottom: 15px;
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
      }

      .student-name {
        font-size: 20px;
        color: #373b40;
        margin-bottom: 8px;
        font-family: "Elliot Sans", Arial, sans-serif !important;
        font-weight: bold;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .info-grid p {
        margin: 3px 0;
        font-size: 12px;
      }

      .assessment-context {
        margin-bottom: 15px;
        padding: 12px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
      }

      .assessment-context h3 {
        color: #373b40;
        font-size: 14px;
        margin-bottom: 5px;
        font-family: "Elliot Sans", Arial, sans-serif !important;
      }

      .assessment-context p {
        font-size: 11px;
        line-height: 1.3;
        color: #555;
      }

      .assessment-results h3 {
        color: #373b40;
        font-size: 14px;
        margin-bottom: 8px;
        font-family: "Elliot Sans", Arial, sans-serif !important;
      }

      .pdf-progress-bars {
        margin: 10px 0;
      }

      .pdf-progress-item {
        margin: 8px 0;
        background: #f5f5f5;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }

      .pdf-progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 12px;
      }

      .pdf-progress-bar {
        height: 15px;
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #ddd;
        position: relative;
      }

      .units-section {
        margin-top: 15px;
      }

      .units-section h3 {
        color: #373b40;
        font-size: 14px;
        margin-bottom: 8px;
        font-family: "Elliot Sans", Arial, sans-serif !important;
      }

      .evidence-section,
      .referee-section {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        height: 100%;
      }

      .evidence-section h4,
      .referee-section h4 {
        font-size: 13px;
        color: #373b40;
        margin-bottom: 5px;
        border-bottom: 1px solid #fdb715;
        padding-bottom: 3px;
        font-family: "Elliot Sans", Arial, sans-serif !important;
        text-align: center;
      }

      .units-section pre {
        white-space: pre-wrap;
        font-family: "Open Sans", Arial, sans-serif !important;
        font-size: 10px;
        line-height: 1.3;
        margin: 0;
        padding: 5px;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #eee;
        max-height: 200px;
        overflow-y: auto;
      }

      .footer-note {
        margin-top: 15px;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 6px;
        border-left: 3px solid #fdb715;
      }

      .footer-note p {
        font-size: 10px;
        color: #666;
        line-height: 1.3;
        margin: 0;
      }

      @media print {
        .pdf-content {
          margin: 0;
          padding: 30px;
          border: none;
          box-shadow: none;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        .status-badge {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        .pdf-progress-fill {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }
      }

      /* Add these styles to your existing CSS */
      .certificate-seal {
        position: absolute;
        top: 15px;
        left: 15px;
        width: 100px;
        height: 100px;
        opacity: 0.9;
        z-index: 2;
      }

      .seal-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .pdf-header {
        text-align: center;
        margin-bottom: 25px;
        padding: 25px 15px;
        border-bottom: 2px solid #fdb715;
        position: relative;
        background: linear-gradient(to bottom, #fff, #fafafa);
      }

      .pdf-header h1 {
        font-size: 32px;
        margin: 35px 0 8px;
        color: #373b40;
        font-family: "Elliot Sans", Arial, sans-serif !important;
        font-weight: bold;
        clear: both;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
      }

      .pdf-header .subtitle {
        font-size: 22px;
        color: #555;
        margin: 8px 0 25px;
        font-family: "Elliot Sans", Arial, sans-serif !important;
        font-weight: normal;
        letter-spacing: 1px;
      }
    </style>
  </head>
  <body>
    <!--========================================================================
                              NAVBAR
    =========================================================================-->
    <header class="navbar animate-on-scroll">
      <div class="navbar__logo">
        <img
          src="https://storage.googleapis.com/msgsndr/gU8WTxeySVWZN6JcUGsl/media/65efcc74ae69d11b44b6731a.png"
          alt="Company Logo"
        />
      </div>
    </header>

    <div class="container">
      <h1 class="animate-on-scroll">Skills and Eligibility Assessment v2</h1>

      <!--========================================================================
                              CARD: STUDENT INFO
      =========================================================================-->
      <div class="card animate-on-scroll">
        <div class="form-section">
          <label for="studentName">Student Name (First and Last):</label>
          <input
            type="text"
            id="studentName"
            placeholder="e.g. Jack Hammer"
            title="Enter full name"
          />

          <label for="studentEmail">Student Email:</label>
          <input
            type="email"
            id="studentEmail"
            placeholder="e.g. jack@screwitbuilders.com.au"
            title="Enter email address"
          />

          <label for="assessmentDate">Assessment Date:</label>
          <input
            type="date"
            id="assessmentDate"
            title="Select assessment date"
          />

          <label for="notes">Assessment Notes:</label>
          <textarea
            id="notes"
            rows="3"
            placeholder="Enter notes here..."
            title="Enter assessment notes"
          ></textarea>
        </div>
      </div>

      <!--========================================================================
                              CARD: WORK HISTORY QUESTIONS
      =========================================================================-->
      <div class="card animate-on-scroll">
        <details class="work-history">
          <summary>Work History Questions</summary>
          <h3>Work History Questions</h3>
          <ol>
            <li>
              <strong>Roles and Timeline</strong>
              <ul>
                <li>List your roles from earliest to current.</li>
                <li>Provide approximate start and end dates or years.</li>
              </ul>
            </li>
          </ol>
          <hr />
          <h3>Role Responsibilities and Achievements</h3>
          <ol start="2">
            <li>
              <strong>Breaking Down Roles</strong>
              <ul>
                <li>Describe key responsibilities and tasks for each role.</li>
                <li>Mention any notable achievements or projects.</li>
                <li>Include team size if applicable.</li>
                <li>List any specific tools or systems used.</li>
              </ul>
            </li>
          </ol>
          <hr />
          <h3>References</h3>
          <ol start="3">
            <li>
              <strong>Reference Details</strong>
              <ul>
                <li>Do you have any professional references?</li>
                <ul>
                  <li>If yes, provide their full names and phone numbers.</li>
                  <li>If not now, we can collect this later.</li>
                </ul>
              </ul>
            </li>
          </ol>
          <hr />
          <h3>Additional Information</h3>
          <ol start="4">
            <li>
              <strong>Skills</strong>
              <ul>
                <li>Mention any specific skills you've developed.</li>
              </ul>
            </li>
            <li>
              <strong>Training and Certifications</strong>
              <ul>
                <li>List any formal training, certifications, or licenses.</li>
              </ul>
            </li>
            <li>
              <strong>Additional Comments</strong>
              <ul>
                <li>Include any other information you'd like to share.</li>
              </ul>
            </li>
          </ol>
        </details>

        <label for="workHistory">Work History:</label>
        <textarea
          id="workHistory"
          rows="3"
          placeholder="Enter work history here..."
          title="Enter work history details"
        ></textarea>

        <label for="callTranscript">Assessment Call Transcript:</label>
        <textarea
          id="callTranscript"
          rows="3"
          placeholder="Enter call transcript here..."
          title="Enter transcript details"
        ></textarea>
      </div>

      <!--========================================================================
                       CARD: QUALIFICATION SELECTION & UNITS TABLE
      =========================================================================-->
      <div class="card animate-on-scroll">
        <div class="form-section">
          <label for="qualificationSelect">Qualification:</label>
          <select id="qualificationSelect" title="Select qualification">
            <option value="">-- Select a Qualification --</option>
            <optgroup label="Standard Qualifications">
              <option value="AHC30921">
                AHC30921 Certificate III in Landscape Construction
              </option>
              <option value="AUR30320">
                AUR30320 Certificate III in Automotive Electrical Technology
              </option>
              <option value="AUR30620">
                AUR30620 Certificate III in Light Vehicle Mechanical Technology
              </option>
              <option value="AUR31120">
                AUR31120 Certificate III in Heavy Commercial Vehicle Mechanical
                Technology
              </option>
              <option value="AUR32420">
                AUR32420 Certificate III in Automotive Refinishing Technology
              </option>
              <option value="AUR40116">
                AUR40116 Certificate IV in Automotive Management
              </option>
              <option value="AUR40216">
                AUR40216 Certificate IV in Automotive Mechanical Diagnosis
              </option>
              <option value="AUR40620">
                AUR40620 Certificate IV in Automotive Electrical Technology
              </option>
              <option value="AUR40820">
                AUR40820 Certificate IV in Automotive Mechanical Overhauling
              </option>
              <option value="AUR50216">
                AUR50216 Diploma of Automotive Technology
              </option>
              <option value="BSB50820">
                BSB50820 Diploma of Project Management
              </option>
              <option value="CPC10120">
                CPC10120 Certificate I in Construction
              </option>
              <option value="CPC30120">
                CPC30120 Certificate III in Shopfitting
              </option>
              <option value="CPC30220">
                CPC30220 Certificate III in Carpentry
              </option>
              <option value="CPC30320">
                CPC30320 Certificate III in Concreting
              </option>
              <option value="CPC30420">
                CPC30420 Certificate III in Demolition
              </option>
              <option value="CPC30620">
                CPC30620 Certificate III in Painting and Decorating
              </option>
              <option value="CPC30820">
                CPC30820 Certificate III in Roof Tiling
              </option>
              <option value="CPC31020">
                CPC31020 Certificate III in Solid Plastering
              </option>
              <option value="CPC31220">
                CPC31220 Certificate III in Wall and Ceiling Lining
              </option>
              <option value="CPC31320">
                CPC31320 Certificate III in Wall and Floor Tiling
              </option>
              <option value="CPC31420">
                CPC31420 Certificate III in Construction Waterproofing
              </option>
              <option value="CPC32420">
                CPC32420 Certificate III in Plumbing
              </option>
              <option value="CPC32620">
                CPC32620 Certificate III in Roof Plumbing
              </option>
              <option value="CPC33020">
                CPC33020 Certificate III in Bricklaying and Blocklaying
              </option>
              <option value="CPC40120">
                CPC40120 Certificate IV in Building and Construction
              </option>
              <option value="CPC40920">
                CPC40920 Certificate IV in Plumbing and Services
              </option>
              <option value="CPC41020">
                CPC41020 Certificate IV in Demolition
              </option>
              <option value="CPC50220">
                CPC50220 Diploma of Building and Construction (Building)
              </option>
              <option value="CPC60220">
                CPC60220 Advanced Diploma of Building and Construction
                (Management)
              </option>
              <option value="CPP41419">
                CPP41419 Certificate IV in Real Estate Practice
              </option>
              <option value="CPP51122">
                CPP51122 Diploma of Property (Agency Management)
              </option>
              <option value="MEM30219">
                MEM30219 Certificate III in Engineering - Mechanical Trade
              </option>
              <option value="MEM31925">
                MEM31925 Certificate III in Engineering - Fabrication Trade
              </option>
              <option value="MEM40119">
                MEM40119 Certificate IV in Engineering
              </option>
              <option value="MSF30322">
                MSF30322 Certificate III in Cabinet Making and Timber Technology
              </option>
              <option value="MSF30422">
                MSF30422 Certificate III in Glass and Glazing
              </option>
              <option value="RII30820">
                RII30820 Certificate III in Civil Construction Plant Operations
              </option>
              <option value="UEE32225">
                UEE32225 Certificate III in Air Conditioning and Refrigeration
              </option>
            </optgroup>
            <optgroup label="--- TSA Qualifications ---">
              <option disabled>--- Mobile Plant ---</option>
              <option value="45637MEM31419">
                MEM31419 Certificate III in Engineering - Fixed and Mobile Plant
                Mechanic
              </option>
              <option value="45637AUR31220">
                AUR31220 Certificate III in Mobile Plant Technology
              </option>
              <option value="45637AUR31220MPE">
                AUR31220 Certificate III in Mobile Plant Technology (Mobile Plant Equipment)
              </option>
              <option value="45637AUR31220F">
                AUR31220 Certificate III in Mobile Plant Technology (Forklift)
              </option>
              <option value="45637AUR31220EWP">
                AUR31220 Certificate III in Mobile Plant Technology (Elevating Work Platform)
              </option>
              <option disabled>--- Engineering - Fabrication Trade ---</option>
              <option value="45637MEM31925">
                MEM31925 Certificate III in Engineering - Fabrication Trade
              </option>
              <option value="45637MEM31925B">
                MEM31925 Certificate III in Engineering - Fabrication Trade (Boilermaker)
              </option>
              <option value="45637MEM31925W">
                MEM31925 Certificate III in Engineering - Fabrication Trade (Welding)
              </option>
              <option value="45637MEM31925BW">
                MEM31925 Certificate III in Engineering - Fabrication Trade (BoilermakingWelding)
              </option>
              <option value="45637MEM31925SM">
                MEM31925 Certificate III in Engineering - Fabrication Trade (SheetMetal)
              </option>
              <option value="45637MEM31925SF">
                MEM31925 Certificate III in Engineering - Fabrication Trade (Surface Finishing)
              </option>
              <option disabled>--- Automotive ---</option>
              <option value="45637AUR32120">
                AUR32120 Certificate III in Automotive Body Repair Technology
              </option>
              <option value="45637AUR32420">
                AUR32420 Certificate III in Automotive Refinishing Technology
              </option>
              <option value="45637AUR30820">
                AUR30820 Certificate III in Motorcycle Mechanical Technology
              </option>
              <option value="45637AUR32721">
                AUR32721 Certificate III in Automotive Electric Vehicle
                Technology
              </option>
              <option value="45637AUR31120">
                AUR31120 Certificate III in Heavy Commercial Vehicle Mechanical
                Technology
              </option>
              <option value="45637AUR30620">
                AUR30620 Certificate III in Light Vehicle Mechanical
                Technology
              </option>

            </optgroup>
          </select>
        </div>
        <div id="unitsContainer"></div>
        <div id="resultsContainer">
          <h3>Assessment Results</h3>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">Total Units</div>
              <div class="stat-value" id="unitCountValue">0</div>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-label">
              <span>Evidence Progress</span>
              <span id="percentageEvidenceValue">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="evidenceProgressBar"></div>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-label">
              <span>Referee Progress</span>
              <span id="percentageRefereeValue">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="refereeProgressBar"></div>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-label">
              <span>Gap Training Progress</span>
              <span id="percentageGapValue">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="gapProgressBar"></div>
            </div>
          </div>
        </div>
      </div>

      <!--========================================================================
                              CARD: UNITS LISTS
      =========================================================================-->
      <div class="card animate-on-scroll">
        <div class="units-lists-container">
          <div class="evidence-units">
            <h4>Evidence Units Selected:</h4>
            <pre id="evidenceUnitsListUI" class="units-list"></pre>
          </div>
          <div class="referee-units">
            <h4>Referee Units Selected:</h4>
            <pre id="refereeUnitsListUI" class="units-list"></pre>
          </div>
          <div class="referee-units">
            <h4>Gap Training Units Selected:</h4>
            <pre id="gapUnitsListUI" class="units-list"></pre>
          </div>
        </div>
      </div>

      <!--========================================================================
                              BUTTONS
      =========================================================================-->
      <div class="button-row animate-on-scroll">
        <button id="generatePdfBtn" class="pdf-button">
          <i class="fas fa-file-pdf"></i> PREVIEW ASSESSMENT PDF
        </button>
        <div class="secondary-buttons">
          <button id="saveToContactBtn">SAVE TO CONTACT</button>
          <button id="clearFormBtn">
            <i class="fas fa-eraser"></i> CLEAR FORM
          </button>
          <button id="saveLocallyBtn">
            <i class="fas fa-hdd"></i> SAVE TO LOCAL STORAGE
          </button>
        </div>
      </div>

      <!--========================================================================
                      LOCAL STORAGE DISPLAY
      =========================================================================-->
      <h2 class="animate-on-scroll">
        Saved Assessments (Local - only saves on this machine)
      </h2>
      <table id="localStorageTable" class="animate-on-scroll">
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Qualification</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="localStorageTbody"></tbody>
      </table>
    </div>

    <!--========================================================================
                             CUSTOM CONFIRMATION MODAL
    =========================================================================-->
    <div
      id="confirmationModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalMessage"
    >
      <div class="modal-content">
        <p id="modalMessage"></p>
        <div class="modal-actions">
          <button id="modalConfirm" class="modal-button confirm">
            <i class="fas fa-check"></i> Confirm
          </button>
          <button id="modalCancel" class="modal-button cancel">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!--========================================================================
                                TOAST CONTAINER
    =========================================================================-->
    <div id="toastContainer"></div>

    <!--========================================================================
                             PDF PREVIEW MODAL
    =========================================================================-->
    <div id="pdfPreviewModal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content pdf-preview-content">
        <div class="pdf-preview-header">
          <h2>Assessment PDF Preview</h2>
          <button id="closePdfPreview" class="close-button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="pdfPreviewContainer"></div>
        <div class="pdf-preview-actions">
          <button id="downloadPdfBtn" class="modal-button confirm">
            <i class="fas fa-download"></i> Download PDF
          </button>
          <button id="cancelPdfPreview" class="modal-button cancel">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!--========================================================================
                             PDF TEMPLATE (Hidden)
    =========================================================================-->
    <div id="pdfTemplate" style="display: none">
      <div class="pdf-content">
        <div class="pdf-header">
          <div class="certificate-seal">
            <img
              src="https://storage.googleapis.com/msgsndr/gU8WTxeySVWZN6JcUGsl/media/67b80907162c154a86357d7b.png"
              alt="Certificate Seal"
              class="seal-image"
            />
          </div>
          <img
            src="https://storage.googleapis.com/msgsndr/gU8WTxeySVWZN6JcUGsl/media/65efcc74ae69d11b44b6731a.png"
            alt="Company Logo"
            class="pdf-logo"
          />
          <div class="assessment-status">
            <span class="status-badge">Preliminary Assessment Completed</span>
          </div>
          <h1>Certificate for</h1>
          <h2 class="subtitle">
            Preliminary Skills Assessment & RPL Evaluation
          </h2>
        </div>
        <div class="pdf-body">
          <div class="student-info">
            <h2 class="student-name" id="pdfStudentName"></h2>
            <div class="info-grid">
              <p>
                <strong>Assessment Date:</strong>
                <span id="pdfAssessmentDate"></span>
              </p>
              <p>
                <strong>Qualification:</strong>
                <span id="pdfQualification"></span>
              </p>
            </div>
          </div>

          <div class="assessment-context">
            <h3>
              Recognition of Prior Learning (RPL) - Preliminary Assessment
            </h3>
            <p>
              This preliminary assessment evaluates your existing skills and
              experience against the core competencies, units of competency,
              elements, and performance criteria of your chosen qualification.
              The results indicate your potential eligibility for RPL based on
              the evidence and referee testimonials discussed during the
              assessment.
            </p>
          </div>

          <div class="assessment-results">
            <h3>Assessment Progress Overview</h3>
            <div class="pdf-progress-bars">
              <div class="pdf-progress-item">
                <div class="pdf-progress-label">
                  <span>Evidence</span>
                  <span id="pdfEvidencePercent"></span>
                </div>
                <div class="pdf-progress-bar">
                  <div class="pdf-progress-fill" id="pdfEvidenceBar"></div>
                </div>
              </div>
              <div class="pdf-progress-item">
                <div class="pdf-progress-label">
                  <span>Referee</span>
                  <span id="pdfRefereePercent"></span>
                </div>
                <div class="pdf-progress-bar">
                  <div class="pdf-progress-fill" id="pdfRefereeBar"></div>
                </div>
              </div>
              <div class="pdf-progress-item">
                <div class="pdf-progress-label">
                  <span>Gap Training</span>
                  <span id="pdfGapPercent"></span>
                </div>
                <div class="pdf-progress-bar">
                  <div class="pdf-progress-fill" id="pdfGapBar"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="units-section">
            <h3>Identified Competencies</h3>
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
              "
            >
              <div class="evidence-section">
                <h4>Evidence Units</h4>
                <pre id="pdfEvidenceUnits"></pre>
              </div>
              <div class="referee-section">
                <h4>Referee Units</h4>
                <pre id="pdfRefereeUnits"></pre>
              </div>
              <div class="referee-section">
                <h4>Gap Training Units</h4>
                <pre id="pdfGapUnits"></pre>
              </div>
            </div>
          </div>

          <div class="footer-note">
            <p>
              This preliminary assessment is part of the RPL process. The next
              steps will involve gathering detailed evidence and documentation
              for the identified units of competency.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!--========================================================================
                              JAVASCRIPT FUNCTIONALITY
    =========================================================================-->
    <script>
      // Global Variables & Data Storage
      let qualificationsData = {};

      // Custom Confirm Modal Function (returns a Promise)
      function customConfirm(message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirmationModal");
          const modalMessage = document.getElementById("modalMessage");
          modalMessage.textContent = message;
          modal.classList.add("show");
          // Display modal using flex
          modal.style.display = "flex";
          const confirmBtn = document.getElementById("modalConfirm");
          const cancelBtn = document.getElementById("modalCancel");
          function cleanup() {
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            modal.classList.remove("show");
            setTimeout(() => {
              modal.style.display = "none";
            }, 300);
          }
          confirmBtn.onclick = () => {
            cleanup();
            resolve(true);
          };
          cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
          };
        });
      }

      // Toast Notification Function
      function showToast(message, isError = false) {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = "toast" + (isError ? " error" : "");
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add("show");
        }, 100);
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 3500);
      }

      // showMessage wrapper for toast notifications
      function showMessage(msg, isError = false) {
        showToast(msg, isError);
      }

      // Unit Table & Real-Time Calculation
      function updateUnits() {
        const qualificationCode = document.getElementById(
          "qualificationSelect"
        ).value;
        const container = document.getElementById("unitsContainer");
        container.innerHTML = "";
        const resultsDiv = document.getElementById("resultsContainer");

        if (!qualificationCode) {
          resultsDiv.style.display = "none";
          return;
        }

        const units = qualificationsData[qualificationCode];
        if (!units || units.length === 0) {
          container.innerHTML =
            "<p>No units found for the selected qualification.</p>";
          resultsDiv.style.display = "none";
          return;
        }

        let html = `
    <table class="qualification-table">
      <colgroup>
        <col style="width: calc(100% - 450px);">
        <col style="width: 150px;">
        <col style="width: 150px;">
        <col style="width: 150px;">
      </colgroup>
      <thead>
        <tr>
          <th>Unit and Description</th>
          <th>Photo / Video / Documents</th>
          <th>Referee</th>
          <th>Gap Training</th>
        </tr>
      </thead>
      <tbody>
  `;

        units.forEach((unit) => {
          const photoId = `photo_${qualificationCode}_${unit.code}`;
          const refereeId = `referee_${qualificationCode}_${unit.code}`;
          const gapId = `gap_${qualificationCode}_${unit.code}`;
          const tgaLink = `https://training.gov.au/Training/Details/${unit.code}`;
          const normType = (unit.type || "").trim().toLowerCase();

          const typeLabel =
            normType === "core"
              ? "Core"
              : normType === "elective"
              ? "Elective"
              : normType === "not included"
              ? "Not Included"
              : "";

          const typeColor =
            normType === "core"
              ? "blue"
              : normType === "not included"
              ? "red"
              : "green";

          const groupLabel = unit.group
            ? ` <strong><span style="color:green">Group: ${unit.group}</span></strong>`
            : "";

          html += `
      <tr>
        <td>
          <strong>${unit.code}: ${unit.name}</strong><span style="color: ${typeColor}; font-weight: bold;"> (${typeLabel}) ${groupLabel}</span><br>
          <small>${unit.desc}</small><br>
          <a href="${tgaLink}" target="_blank" class="tga-link-button">
            <i class="fas fa-book"></i> View Official Unit Details on Training.Gov.au
          </a>
        </td>
        <td>
          <label>
            <input type="checkbox" id="${photoId}" data-qual="${qualificationCode}" data-code="${unit.code}" />
          </label>
        </td>
        <td>
          <label>
            <input type="checkbox" id="${refereeId}" data-qual="${qualificationCode}" data-code="${unit.code}" />
          </label>
        </td>
        <td>
          <label>
            <input type="checkbox" id="${gapId}" data-qual="${qualificationCode}" data-code="${unit.code}" />
          </label>
        </td>
      </tr>
    `;
        });

        html += `
      </tbody>
    </table>
  `;

        container.innerHTML = html;
        resultsDiv.style.display = "block";
        container.addEventListener("change", handleCheckChange);
        calculateAndDisplayResults();
      }

      function handleCheckChange(e) {
        if (e.target && e.target.type === "checkbox") {
          calculateAndDisplayResults();
        }
      }

      function calculateAndDisplayResults() {
        const qualificationCode = document.getElementById(
          "qualificationSelect"
        ).value;
        const { unitCount, evidencePercent, refereePercent, gapPercent } =
          getStatsFromCheckedBoxes(qualificationCode);

        document.getElementById("unitCountValue").textContent = unitCount;
        document.getElementById("percentageEvidenceValue").textContent =
          evidencePercent + "%";
        document.getElementById("percentageRefereeValue").textContent =
          refereePercent + "%";
        document.getElementById("percentageGapValue").textContent =
          gapPercent + "%";

        document.getElementById("evidenceProgressBar").style.width =
          evidencePercent + "%";
        document.getElementById("refereeProgressBar").style.width =
          refereePercent + "%";
        document.getElementById("gapProgressBar").style.width =
          gapPercent + "%";

        const { evidenceList, refereeList, gapList } =
          getEvidenceRefereeLists(qualificationCode);
        document.getElementById("evidenceUnitsListUI").textContent =
          evidenceList;
        document.getElementById("refereeUnitsListUI").textContent = refereeList;
        document.getElementById("gapUnitsListUI").textContent = gapList;
      }

      function getStatsFromCheckedBoxes(qualificationCode) {
        if (!qualificationCode) {
          return {
            unitCount: 0,
            evidencePercent: 0,
            refereePercent: 0,
            gapPercent: 0,
          };
        }
        const units = qualificationsData[qualificationCode] || [];
        const totalUnits = units.length;
        let evidenceCount = 0,
          refereeCount = 0,
          gapCount = 0;

        units.forEach((unit) => {
          const photoId = `photo_${qualificationCode}_${unit.code}`;
          const refereeId = `referee_${qualificationCode}_${unit.code}`;
          const gapId = `gap_${qualificationCode}_${unit.code}`;

          if (document.getElementById(photoId)?.checked) evidenceCount++;
          if (document.getElementById(refereeId)?.checked) refereeCount++;
          if (document.getElementById(gapId)?.checked) gapCount++;
        });

        const percent = (count) =>
          totalUnits > 0 ? Math.round((count / totalUnits) * 100) : 0;

        return {
          unitCount: totalUnits,
          evidencePercent: percent(evidenceCount),
          refereePercent: percent(refereeCount),
          gapPercent: percent(gapCount),
        };
      }

      function getEvidenceRefereeLists(qualificationCode) {
        let evidenceListString = "",
          refereeListString = "",
          gapListString = "";

        if (!qualificationCode)
          return { evidenceList: "", refereeList: "", gapList: "" };
        const units = qualificationsData[qualificationCode] || [];

        units.forEach((unit) => {
          const photoId = `photo_${qualificationCode}_${unit.code}`;
          const refereeId = `referee_${qualificationCode}_${unit.code}`;
          const gapId = `gap_${qualificationCode}_${unit.code}`;

          if (document.getElementById(photoId)?.checked) {
            evidenceListString += `${unit.code}: ${unit.name}\n`;
          }
          if (document.getElementById(refereeId)?.checked) {
            refereeListString += `${unit.code}: ${unit.name}\n`;
          }
          if (document.getElementById(gapId)?.checked) {
            gapListString += `${unit.code}: ${unit.name}\n`;
          }
        });

        return {
          evidenceList: evidenceListString.trim(),
          refereeList: refereeListString.trim(),
          gapList: gapListString.trim(),
        };
      }

      // Data Submission & Webhook
      function sendToWebhookData(payload) {
        const webhookUrl =
          "https://services.leadconnectorhq.com/hooks/gU8WTxeySVWZN6JcUGsl/webhook-trigger/20f49e59-0fe1-4334-91ac-9cf4b82c47c8";
        if (!payload.name) {
          showMessage("Error: 'name' is missing.", true);
          return;
        }
        if (!payload.date) {
          showMessage("Error: 'date' is missing. Please select a date.", true);
          return;
        }
        if (!payload.notes.trim()) {
          showMessage(
            "'notes' cannot be empty. Please enter some notes.",
            true
          );
          return;
        }
        if (!payload.name.includes(" ")) {
          showMessage(
            "Invalid student name. Make sure it includes first and last name.",
            true
          );
          return;
        }
        fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((response) => {
            if (response.ok) {
              showMessage("Assessment saved to CRM and Student Folder!");
            } else {
              showMessage(
                "Error sending data to webhook. Check logs or console.",
                true
              );
            }
          })
          .catch((error) => {
            console.error("Webhook error:", error);
            showMessage(
              "An error occurred while sending data to webhook. Check console.",
              true
            );
          });
      }

      async function sendToWebhook() {
        const confirmed = await customConfirm(
          "Are you sure you want to save to contact?"
        );
        if (!confirmed) return;
        const payload = fetchData();
        sendToWebhookData(payload);
      }

      function fetchData() {
        const studentName = document.getElementById("studentName").value || "";
        const studentEmail =
          document.getElementById("studentEmail").value || "";
        const dateValue = document.getElementById("assessmentDate").value || "";
        const notes = document.getElementById("notes").value || "";
        const workHistory = document.getElementById("workHistory").value || "";
        const callTranscript =
          document.getElementById("callTranscript").value || "";
        const qualificationSelectEl = document.getElementById(
          "qualificationSelect"
        );

        const qualificationSelectedFullText =
          qualificationSelectEl.options[qualificationSelectEl.selectedIndex]
            ?.text || "";
        const qualificationSelectedValue = qualificationSelectEl.value || "";

        let formattedDate = "";
        if (dateValue) {
          const parts = dateValue.split("-");
          if (parts.length === 3) {
            const [yyyy, mm, dd] = parts;
            formattedDate = `${dd}-${mm}-${yyyy}`;
          }
        }

        const { unitCount, evidencePercent, refereePercent, gapPercent } =
          getStatsFromCheckedBoxes(qualificationSelectedValue);

        const { evidenceList, refereeList, gapList } = getEvidenceRefereeLists(
          qualificationSelectedValue
        );

        return {
          name: studentName,
          email: studentEmail,
          date: formattedDate,
          notes,
          workHistory,
          callTranscript,
          qualification: qualificationSelectedFullText,
          unitCount,
          percentageOfEvidence: evidencePercent + "%",
          percentageOfReferee: refereePercent + "%",
          percentageOfGap: gapPercent + "%",
          unitsEvidenceList: evidenceList || "",
          unitsRefereeList: refereeList || "",
          unitsGapList: gapList || "",
          evidenceCount: evidencePercent,
          refereeCount: refereePercent,
          gapCount: gapPercent,
        };
      }

      async function clearForm() {
        const confirmed = await customConfirm(
          "Are you sure you want to clear the form? This action cannot be undone."
        );
        if (!confirmed) {
          showMessage("Form clearing cancelled.", true);
          return;
        }

        // Reset text inputs
        document.getElementById("studentName").value = "";
        document.getElementById("studentEmail").value = "";
        document.getElementById("assessmentDate").value = "";
        document.getElementById("notes").value = "";
        document.getElementById("qualificationSelect").value = "";
        document.getElementById("workHistory").value = "";
        document.getElementById("callTranscript").value = "";

        // Clear checkboxes (unit selectors)
        document
          .querySelectorAll("#unitsContainer input[type='checkbox']")
          .forEach((checkbox) => {
            checkbox.checked = false;
          });

        // Clear stat boxes and progress bars
        document.getElementById("unitCountValue").textContent = "0";
        document.getElementById("percentageEvidenceValue").textContent = "0%";
        document.getElementById("percentageRefereeValue").textContent = "0%";
        document.getElementById("percentageGapValue").textContent = "0%";
        document.getElementById("evidenceProgressBar").style.width = "0%";
        document.getElementById("refereeProgressBar").style.width = "0%";
        document.getElementById("gapProgressBar").style.width = "0%";

        // Clear units list UI preview
        document.getElementById("evidenceUnitsListUI").textContent = "";
        document.getElementById("refereeUnitsListUI").textContent = "";
        document.getElementById("gapUnitsListUI").textContent = "";

        // Optionally clear unit table and hide result box
        document.getElementById("unitsContainer").innerHTML = "";
        document.getElementById("resultsContainer").style.display = "none";

        showMessage("Form fields cleared successfully!");
      }

      async function deleteLocalAssessment(index) {
        const confirmed = await customConfirm(
          "Are you sure you want to delete this assessment from local storage?"
        );
        if (!confirmed) return;
        const storedAssessments =
          JSON.parse(localStorage.getItem("assessments")) || [];
        storedAssessments.splice(index, 1);
        localStorage.setItem("assessments", JSON.stringify(storedAssessments));
        renderLocalData();
        showMessage("Assessment deleted from local storage!");
      }

      // Local Storage CRUD Functions
      function saveAssessmentLocally() {
        const data = fetchData();
        const existing = JSON.parse(localStorage.getItem("assessments")) || [];
        existing.push(data);
        localStorage.setItem("assessments", JSON.stringify(existing));
        renderLocalData();
        showMessage("Assessment saved locally!");
      }

      function renderLocalData() {
        const tableBody = document.getElementById("localStorageTbody");
        tableBody.innerHTML = "";
        const storedAssessments =
          JSON.parse(localStorage.getItem("assessments")) || [];
        storedAssessments.forEach((assessment, index) => {
          const row = document.createElement("tr");

          // Name column
          const nameTd = document.createElement("td");
          nameTd.textContent = assessment.name;
          row.appendChild(nameTd);

          // Date column
          const dateTd = document.createElement("td");
          dateTd.textContent = assessment.date;
          row.appendChild(dateTd);

          // Qualification column
          const qualTd = document.createElement("td");
          qualTd.textContent = assessment.qualification;
          row.appendChild(qualTd);

          // Actions column
          const actionsTd = document.createElement("td");
          const actionButtonsContainer = document.createElement("div");
          actionButtonsContainer.classList.add("action-buttons");

          // Save button with PNG icon (no text)
          const saveBtn = document.createElement("button");
          saveBtn.innerHTML =
            '<img src="https://storage.googleapis.com/msgsndr/gU8WTxeySVWZN6JcUGsl/media/67a578801acd2a7e04f55ece.png" alt="Save">';
          saveBtn.onclick = () => {
            customConfirm(
              "Are you sure you want to send this saved assessment to contact?"
            ).then((confirmed) => {
              if (confirmed) {
                sendToWebhookData(assessment);
              }
            });
          };
          actionButtonsContainer.appendChild(saveBtn);

          // Delete button with PNG icon (no text)
          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML =
            '<img src="https://storage.googleapis.com/msgsndr/gU8WTxeySVWZN6JcUGsl/media/67a5788023290224a93a246f.png" alt="Delete">';
          deleteBtn.onclick = () => {
            deleteLocalAssessment(index);
          };
          actionButtonsContainer.appendChild(deleteBtn);

          actionsTd.appendChild(actionButtonsContainer);
          row.appendChild(actionsTd);

          tableBody.appendChild(row);
        });
      }

      // Load Qualifications Data (JSON)
      async function loadQualificationsData() {
        try {
          const response = await fetch(
            "https://raw.githubusercontent.com/abcereno/qualifications/refs/heads/main/quals.json"
          );
          if (!response.ok)
            throw new Error("Failed to load qualifications data.");
          qualificationsData = await response.json();
          console.log("Qualifications data loaded:", qualificationsData);
          updateUnits();
        } catch (error) {
          console.error("Error fetching JSON:", error);
        }
      }

      // Intersection Observer for scroll animations (adds "in-view" only once)
      function handleScrollAnimations() {
        const scrollElements = document.querySelectorAll(".animate-on-scroll");
        const observer = new IntersectionObserver(
          (entries, observer) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("in-view");
                observer.unobserve(entry.target);
              }
            });
          },
          { threshold: 0.2 }
        );
        scrollElements.forEach((el) => observer.observe(el));
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", () => {
        renderLocalData();
        loadQualificationsData();
        document
          .getElementById("qualificationSelect")
          .addEventListener("change", updateUnits);
        document
          .getElementById("saveToContactBtn")
          .addEventListener("click", sendToWebhook);
        document
          .getElementById("clearFormBtn")
          .addEventListener("click", clearForm);
        document
          .getElementById("saveLocallyBtn")
          .addEventListener("click", saveAssessmentLocally);
        document
          .getElementById("generatePdfBtn")
          .addEventListener("click", generatePdf);
        document
          .getElementById("downloadPdfBtn")
          .addEventListener("click", downloadPdf);
        document
          .getElementById("closePdfPreview")
          .addEventListener("click", closePdfPreview);
        document
          .getElementById("cancelPdfPreview")
          .addEventListener("click", closePdfPreview);
        handleScrollAnimations();
      });

      // PDF Generation Functions
// 👉 Fixed counts
const PAGE1_UNITS_PER_COLUMN = 5;
const NEXTPAGES_UNITS_PER_COLUMN = 20;

async function downloadPdf() {
  try {
    showMessage("Generating PDF…");
    const data = fetchData();

    // ---------- OFF-SCREEN STAGE ----------
    const stage = document.createElement("div");
    stage.style.position = "absolute";
    stage.style.left = "-9999px";
    stage.style.top = "-9999px";
    stage.style.width = "794px"; // A4 width @ 96dpi
    document.body.appendChild(stage);

    // Arrays of units (split by newline; empty lines removed)
    const evidAll = (data.unitsEvidenceList || "").split("\n").map(s=>s.trim()).filter(Boolean);
    const refAll  = (data.unitsRefereeList  || "").split("\n").map(s=>s.trim()).filter(Boolean);
    const gapAll  = (data.unitsGapList      || "").split("\n").map(s=>s.trim()).filter(Boolean);

    // ---------- PAGE 1 (SHOW UP TO 5 PER COLUMN) ----------
    const page1 = document.getElementById("pdfTemplate").cloneNode(true);
    page1.style.display = "block";
    stage.appendChild(page1);

    // Header + meta
    setTextSafe(page1, "#pdfStudentName", data.name);
    setTextSafe(page1, "#pdfAssessmentDate", data.date);
    setTextSafe(page1, "#pdfQualification", data.qualification);

    // Percentages + bars
    setTextSafe(page1, "#pdfEvidencePercent", data.percentageOfEvidence || "0%");
    setTextSafe(page1, "#pdfRefereePercent",  data.percentageOfReferee  || "0%");
    setTextSafe(page1, "#pdfGapPercent",      data.percentageOfGap      || "0%");
    setBarWidthSafe(page1, "#pdfEvidenceBar", data.percentageOfEvidence);
    setBarWidthSafe(page1, "#pdfRefereeBar",  data.percentageOfReferee);
    setBarWidthSafe(page1, "#pdfGapBar",      data.percentageOfGap);

    // First 5 per column
    setTextSafe(page1, "#pdfEvidenceUnits", evidAll.slice(0, PAGE1_UNITS_PER_COLUMN).join("\n") || " ");
    setTextSafe(page1, "#pdfRefereeUnits",  refAll.slice(0,  PAGE1_UNITS_PER_COLUMN).join("\n") || " ");
    setTextSafe(page1, "#pdfGapUnits",      gapAll.slice(0,  PAGE1_UNITS_PER_COLUMN).join("\n") || " ");

    // Ensure columns render fully (avoid scroll clipping)
    fitPreColumnsToAvailableHeight(page1);

    // Render page 1 -> PDF
    await new Promise(r => setTimeout(r, 120));
    const canvas1 = await html2canvas(page1, { scale: 2, useCORS: true, allowTaint: true, logging: false });
    const pdf = new jspdf.jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
    const pdfWidth = 210;
    const imgHeight1 = (canvas1.height * pdfWidth) / canvas1.width;
    pdf.addImage(canvas1.toDataURL("image/jpeg", 1.0), "JPEG", 0, 0, pdfWidth, imgHeight1);
    stage.removeChild(page1);

    // Remaining items after first 5
    const evidRemain = evidAll.slice(PAGE1_UNITS_PER_COLUMN);
    const refRemain  = refAll.slice(PAGE1_UNITS_PER_COLUMN);
    const gapRemain  = gapAll.slice(PAGE1_UNITS_PER_COLUMN);

    // If anything remains, paginate at 20 per column/page
    if (evidRemain.length || refRemain.length || gapRemain.length) {
      // Prebuild a "units-only" measuring copy just to set heights properly
      const measure = document.getElementById("pdfTemplate").cloneNode(true);
      measure.style.display = "block";
      stage.appendChild(measure);
      // Keep only header + units section
      [".student-info", ".assessment-context", ".assessment-results", ".footer-note"].forEach(sel => {
        const n = measure.querySelector(sel);
        if (n) n.remove();
      });
      const hdr = measure.querySelector(".pdf-header h1");
      if (hdr) hdr.textContent = "Continuation";
      fitPreColumnsToAvailableHeight(measure); // set pre heights
      stage.removeChild(measure);

      const pagesNeeded = Math.max(
        Math.ceil(evidRemain.length / NEXTPAGES_UNITS_PER_COLUMN),
        Math.ceil(refRemain.length  / NEXTPAGES_UNITS_PER_COLUMN),
        Math.ceil(gapRemain.length  / NEXTPAGES_UNITS_PER_COLUMN),
      );

      for (let i = 0; i < pagesNeeded; i++) {
        const unitsPage = document.getElementById("pdfTemplate").cloneNode(true);
        unitsPage.style.display = "block";
        stage.appendChild(unitsPage);

        // Remove non-units sections
        [".student-info", ".assessment-context", ".assessment-results", ".footer-note"].forEach(sel => {
          const n = unitsPage.querySelector(sel);
          if (n) n.remove();
        });

        const hdr2 = unitsPage.querySelector(".pdf-header h1");
        if (hdr2) hdr2.textContent = "Continuation";

        setTextSafe(unitsPage, "#pdfStudentName", data.name);
        setTextSafe(unitsPage, "#pdfAssessmentDate", data.date);
        setTextSafe(unitsPage, "#pdfQualification", data.qualification);

        // Slice 20 per column per page
        const start = i * NEXTPAGES_UNITS_PER_COLUMN;
        const end   = start + NEXTPAGES_UNITS_PER_COLUMN;

        setTextSafe(unitsPage, "#pdfEvidenceUnits", evidRemain.slice(start, end).join("\n") || " ");
        setTextSafe(unitsPage, "#pdfRefereeUnits",  refRemain.slice(start,  end).join("\n") || " ");
        setTextSafe(unitsPage, "#pdfGapUnits",      gapRemain.slice(start,  end).join("\n") || " ");

        unlimitPreColumns(unitsPage);

        await new Promise(r => setTimeout(r, 120));
        const cnv = await html2canvas(unitsPage, { scale: 2, useCORS: true, allowTaint: true, logging: false });
        const imgH = (cnv.height * pdfWidth) / cnv.width;
        pdf.addPage();
        pdf.addImage(cnv.toDataURL("image/jpeg", 1.0), "JPEG", 0, 0, pdfWidth, imgH);

        stage.removeChild(unitsPage);
      }
    }

    // ---------- SAVE ----------
    let filename = "Assessment Results.pdf";
    if (data.name) {
      const parts = data.name.trim().split(" ");
      if (parts.length >= 2) {
        const last = parts.pop();
        const first = parts.join(" ");
        filename = `${last}, ${first} Assessment Results.pdf`;
      } else {
        filename = `Assessment Results ${data.name}.pdf`;
      }
    }
    pdf.save(filename);
    // Also upload to Drive:
try {
  const uploaded = await uploadPdfToDrive(pdf, filename);
  console.log("Drive upload OK:", uploaded);
  showMessage(`Uploaded to Drive: ${uploaded.name}`);
  // If you enabled link sharing in Apps Script, you can show uploaded.url
} catch (err) {
  console.error(err);
  showMessage("Drive upload failed. Check console.", true);
}
    // Cleanup
    document.body.removeChild(stage);
    closePdfPreview();
    showMessage("PDF downloaded successfully!");
  } catch (err) {
    console.error("PDF generation error:", err);
    showMessage("Error generating PDF.", true);
  }
}

// --- helpers ---
// === Configure these ===
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxFIDjUUZB-r9X2O1BAjIPgbzj_K8TkifRDzIkXI026_x18CRtj87TcjzWX1yYOnW7p/exec"; // your deployment URL
const GAS_API_KEY    = "uZy2yW!iX9zv1-6kO4pA7qR0nH3sD8tL"; // must match Script Property API_KEY

// Turn a Blob -> base64 (no data: prefix)
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onloadend = () => {
      const dataUrl = String(reader.result || "");
      const base64 = dataUrl.slice(dataUrl.indexOf(",") + 1);
      resolve(base64);
    };
    reader.readAsDataURL(blob);
  });
}

// Upload a jsPDF instance to Drive via your Apps Script
async function uploadPdfToDrive(pdf, filename = "assessment.pdf") {
  // 1) Get a Blob from jsPDF
  const blob = pdf.output("blob"); // jsPDF API

  // 2) Convert to base64 for Apps Script
  const base64 = await blobToBase64(blob);

  // 3) POST to the Web App
  // Use text/plain to avoid a CORS preflight (simpler & works with doPost parsing)
  const res = await fetch(`${GAS_WEBAPP_URL}?key=${encodeURIComponent(GAS_API_KEY)}`, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      filename,
      base64,
      mimeType: "application/pdf",
    }),
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Upload failed (${res.status}) ${txt}`);
  }

  // 4) Read JSON reply from Apps Script
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "Unknown upload error");
  return json; // { ok:true, id, url, name }
}

// For continued (units-only) pages: let the <pre> columns grow naturally
function unlimitPreColumns(pageRoot) {
  ["#pdfEvidenceUnits", "#pdfRefereeUnits", "#pdfGapUnits"].forEach((sel) => {
    const pre = pageRoot.querySelector(sel);
    if (pre) {
      pre.style.maxHeight = "none";
      pre.style.height = "auto";
      pre.style.overflow = "visible";
      pre.style.whiteSpace = "pre-wrap"; // keep wrapping of long lines
    }
  });
}
function sliceLines(linesArray, pageIndex, linesPerCol) {
  const start = pageIndex * linesPerCol;
  const end = start + linesPerCol;
  return linesArray.slice(start, end);
}

// Fit <pre> columns to the available height of the units section on the given page node
function fitPreColumnsToAvailableHeight(pageRoot) {
  const unitsSection = pageRoot.querySelector(".units-section");
  if (!unitsSection) return;

  const r = unitsSection.getBoundingClientRect();
  const h = Math.max(0, r.height - 16); // small buffer for inner padding/borders

  ["#pdfEvidenceUnits", "#pdfRefereeUnits", "#pdfGapUnits"].forEach((sel) => {
    const pre = pageRoot.querySelector(sel);
    if (pre) {
      pre.style.maxHeight = "none";
      pre.style.height = "auto";
      pre.style.overflow = "hidden";
      pre.style.whiteSpace = "pre-wrap"; // ensure wrapping behaves consistently
    }
  });
}

// How many lines fit per <pre> on *units-only* pages
function computeUnitsLinesPerColumn(unitsOnlyPage) {
  const PAGE_PX = 1123; // matches your .pdf-content min-height @ 96dpi

  const content = unitsOnlyPage.querySelector(".pdf-content");
  const header  = unitsOnlyPage.querySelector(".pdf-header");
  const unitsSection = unitsOnlyPage.querySelector(".units-section");

  const csContent = window.getComputedStyle(content);
  const padTop = parseFloat(csContent.paddingTop) || 0;
  const padBot = parseFloat(csContent.paddingBottom) || 0;

  const headerH = header ? header.offsetHeight : 0;
  const unitsTitle = unitsSection ? unitsSection.querySelector("h3") : null;
  const unitsTitleH = unitsTitle ? unitsTitle.offsetHeight : 0;

  const availablePx = Math.max(100, PAGE_PX - padTop - padBot - headerH - unitsTitleH - 20);

  const pre = unitsOnlyPage.querySelector("#pdfEvidenceUnits");
  const csPre = window.getComputedStyle(pre);
  const lineH = parseFloat(csPre.lineHeight) || 12;

  return Math.max(1, Math.floor(availablePx / lineH));
}

// How many lines fit per <pre> on PAGE 1 (where student info, context, results, footer exist)
function computeLinesPerColumnOnPage1(page1Node) {
  // We’ll measure the actual available height of the page-1 units section after all sections render.
  const unitsSection = page1Node.querySelector(".units-section");
  if (!unitsSection) return 1;

  // Compute the height that <pre> columns can use
  const rect = unitsSection.getBoundingClientRect();
  const availablePx = Math.max(60, rect.height - 16);

  const pre = page1Node.querySelector("#pdfEvidenceUnits");
  const csPre = window.getComputedStyle(pre);
  const lineH = parseFloat(csPre.lineHeight) || 12;

  return Math.max(1, Math.floor(availablePx / lineH));
}

function setTextSafe(root, selector, value) {
  const el = root.querySelector(selector);
  if (el) el.textContent = value || "";
}

function setBarWidthSafe(root, selector, pctText) {
  const el = root.querySelector(selector);
  if (!el) return;
  el.style.cssText = `
    width: ${pctText || "0%"};
    display:block; background-color:#fdb715 !important;
    position:absolute; height:100%; left:0; top:0;
  `;
}

      function updatePdfTemplate() {
        const data = fetchData();
        const qualificationSelect = document.getElementById(
          "qualificationSelect"
        );
        const selectedQualification =
          qualificationSelect.options[qualificationSelect.selectedIndex]
            ?.text || "";

        document.getElementById("pdfStudentName").textContent = data.name || "";
        document.getElementById("pdfAssessmentDate").textContent =
          data.date || "";
        document.getElementById("pdfQualification").textContent =
          selectedQualification || "";

        const evidencePercent = data.percentageOfEvidence || "0%";
        const refereePercent = data.percentageOfReferee || "0%";
        const gapPercent = data.percentageOfGap || "0%";

        document.getElementById("pdfEvidencePercent").textContent =
          evidencePercent;
        document.getElementById("pdfRefereePercent").textContent =
          refereePercent;
        document.getElementById("pdfGapPercent").textContent = gapPercent;

        const evidenceBar = document.getElementById("pdfEvidenceBar");
        const refereeBar = document.getElementById("pdfRefereeBar");
        const gapBar = document.getElementById("pdfGapBar");

        evidenceBar.style.cssText = `
    width: ${evidencePercent};
    display: block;
    background-color: #fdb715 !important;
    position: absolute;
    height: 100%;
    left: 0;
    top: 0;
  `;
        refereeBar.style.cssText = `
    width: ${refereePercent};
    display: block;
    background-color: #fdb715 !important;
    position: absolute;
    height: 100%;
    left: 0;
    top: 0;
  `;
        gapBar.style.cssText = `
    width: ${gapPercent};
    display: block;
    background-color: #fdb715 !important;
    position: absolute;
    height: 100%;
    left: 0;
    top: 0;
  `;

        document.getElementById("pdfEvidenceUnits").textContent =
          data.unitsEvidenceList || "No units selected";
        document.getElementById("pdfRefereeUnits").textContent =
          data.unitsRefereeList || "No units selected";
        document.getElementById("pdfGapUnits").textContent =
          data.unitsGapList || "No units selected";
      }

      function generatePdf() {
        // Validate required fields
        const data = fetchData();
        if (
          !data.name ||
          !data.date ||
          !document.getElementById("qualificationSelect").value
        ) {
          showMessage(
            "Please fill in all required fields (Name, Date, and Qualification) before generating PDF.",
            true
          );
          return;
        }

        // Update the PDF template with current data
        updatePdfTemplate();

        // Show preview modal
        const pdfPreviewModal = document.getElementById("pdfPreviewModal");
        const pdfTemplate = document
          .getElementById("pdfTemplate")
          .cloneNode(true);
        pdfTemplate.style.display = "block";

        const pdfPreviewContainer = document.getElementById(
          "pdfPreviewContainer"
        );
        pdfPreviewContainer.innerHTML = "";
        pdfPreviewContainer.appendChild(pdfTemplate);

        pdfPreviewModal.style.display = "flex";
        setTimeout(() => {
          pdfPreviewModal.classList.add("show");
        }, 10);
      }

      function closePdfPreview() {
        const modal = document.getElementById("pdfPreviewModal");
        modal.classList.remove("show");
        setTimeout(() => {
          modal.style.display = "none";
          document.getElementById("pdfPreviewContainer").innerHTML = ""; // ← add this line
        }, 300);
      }
    </script>
  </body>
</html>
